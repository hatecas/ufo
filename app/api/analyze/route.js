import { NextResponse } from 'next/server';

const ANALYSIS_PROMPT = (machineType, prizeType) => `
ã‚ãªãŸã¯UFOã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ³ã‚²ãƒ¼ãƒ ï¼‰ã®æ”»ç•¥ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚æ—¥æœ¬èªã®å°‚é–€ç”¨èªã«ç²¾é€šã—ã€ä½•åƒå›ã‚‚ã®å®Ÿæˆ¦çµŒé¨“ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒUFOã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’åˆ†æã—ã¦ã€éŸ“å›½èªã§æ”»ç•¥æ³•ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸæƒ…å ±:
- æ©Ÿä½“ã‚¿ã‚¤ãƒ—: ${machineType || "ä¸æ˜"}
- æ™¯å“ã‚¿ã‚¤ãƒ—: ${prizeType || "ä¸æ˜"}

ã€æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘å†™çœŸã«æ˜ ã£ã¦ã„ãªã„ã‚‚ã®ã¯çµ¶å¯¾ã«æ¨æ¸¬ã—ãªã„ã§ãã ã•ã„ã€‚
- ã‚¢ãƒ¼ãƒ ï¼ˆé›†è¨ˆï¼‰ãŒå†™çœŸã«æ˜ ã£ã¦ã„ãªã„å ´åˆ â†’ machine_typeã«ã€Œì§‘ê²Œ ë¯¸í™•ì¸ (ì‚¬ì§„ì— ë³´ì´ì§€ ì•ŠìŒ)ã€ã¨æ›¸ã
- ã‚¢ãƒ¼ãƒ ã®æœ¬æ•°ãŒç¢ºèªã§ããªã„å ´åˆ â†’ æ¨æ¸¬ã›ãšã€Œí™•ì¸ ë¶ˆê°€ã€ã¨æ˜è¨˜ã™ã‚‹
- æ™¯å“ã®è£å´ãŒè¦‹ãˆãªã„å ´åˆ â†’ ã€Œë’·ë©´ ë¯¸í™•ì¸ã€ã¨æ˜è¨˜ã™ã‚‹
- ç¢ºä¿¡ãŒæŒã¦ãªã„æƒ…å ±ã«ã¯å¿…ãšã€Œì¶”ì •ã€ã€Œë¶ˆí™•ì‹¤ã€ã‚’ä»˜ã‘ã‚‹

ã€ã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã®è‡ªå‹•åˆ†é¡ â€” éå¸¸ã«é‡è¦ã€‘
å†™çœŸã‚’è¦‹ã¦ã€ä»¥ä¸‹ã®ã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã‹ã‚‰æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’1ã¤é¸æŠã—ã¦ãã ã•ã„:
1. æ©‹æ¸¡ã— (hashiwatashi) â€” 2æœ¬ã®å¹³è¡Œãªæ£’ã®ä¸Šã«æ™¯å“ã€‚æ—¥æœ¬ã§æœ€ã‚‚ä¸€èˆ¬çš„ã€‚
2. æœ«åºƒãŒã‚Š (suehirogari) â€” æ£’ãŒå¾ã€…ã«åºƒãŒã‚‹ã€‚ç‰¹å®šåœ°ç‚¹ã§ã®ã¿é€šéå¯èƒ½ã€‚éæ¨å¥¨ã€‚
3. å‰è½ã¨ã— (maeotoshi) â€” æ™¯å“ãŒå‰æ–¹ã«å‚¾ã„ãŸçŠ¶æ…‹ã€‚å¾Œéƒ¨ã‚’äº¤äº’ã«å¼•ã„ã¦å‰ã«è½ã¨ã™ã€‚
4. ãƒ©ãƒãƒ¼ã‚·ãƒ§ãƒ™ãƒ« (rubber_shovel) â€” ã‚´ãƒ ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ä»˜ãã‚¢ãƒ¼ãƒ ã§ç®±ã‚’æŠ¼ã™ã€‚Round1ã§å¤šã„ã€‚
5. ãƒªãƒ³ã‚°ã‚¿ã‚¤ãƒ— (ring) â€” C/Dãƒªãƒ³ã‚°ã«å¼•ã£æ›ã‘ã‚‹ã‚¿ã‚¤ãƒ—ã€‚ç²¾åº¦ãŒå‘½ã€‚
6. ã‚³ãƒ¼ãƒŠãƒ¼ãƒãƒ©ãƒ³ã‚¹ (corner_balance) â€” Lå­—æ£šã®ä¸Šã®æ™¯å“ã€‚é‡å¿ƒç§»å‹•ã§è½ã¨ã™ã€‚
7. ç¢ºç‡æ©Ÿ (probability) â€” æ£’æŠ¼ã—ãƒ»ãƒ‰ãƒªãƒ«ãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãªã©ã€‚ä¸€å®šé‡‘é¡ã¾ã§å¾®å¦™ã«ã‚ºãƒ¬ã‚‹æ§‹é€ ã€‚

ã€ã‚¯ãƒ­ãƒ¼ï¼ˆã‚¢ãƒ¼ãƒ ï¼‰ã‚¿ã‚¤ãƒ—ã®åˆ†é¡ã€‘
è¦‹ãˆã‚‹å ´åˆã®ã¿:
- 2æœ¬ã‚¢ãƒ¼ãƒ  (two_arm): å¹³è¡Œãª2æœ¬ã®çˆªã€‚é–‹é–‰ã®ã¿ã€‚ãƒœãƒƒã‚¯ã‚¹å‹æ™¯å“ã«é©åˆã€‚
- 3æœ¬ã‚¢ãƒ¼ãƒ  (three_arm): ä¸‰è§’é…ç½®ã€‚ã»ã¼100%ç¢ºç‡æ©Ÿã€‚ã‚¿ã‚°ã‚„éš™é–“ã‚’æ´»ç”¨ã€‚
- ãƒ”ãƒ³ã‚µãƒ¼å‹ (pincer): æ¿çŠ¶ã€‚å°å‹æ™¯å“ç”¨ã€‚

ã€æ”»ç•¥æŠ€è¡“ã®å®Œå…¨ãƒªã‚¹ãƒˆ â€” æœ€é©ãªã‚‚ã®ã‚’é¸æŠã€‘
- æ©‹æ¸¡ã— (hashiwatashi): 2æœ¬ã®æ£’ã®é–“ã®æ™¯å“ã‚’å›è»¢ãƒ»æŠ¼ã—ã¦è½ã¨ã™
- ç¸¦ãƒãƒ¡ (tatehame): ç®±ã‚’ç¸¦ã«ã—ã¦æ£’ã®é–“ã«é€šã™ã€‚æ£’é–“éš”ãŒç‹­ã„æ™‚ã«æœ‰åŠ¹ã€‚3~5å›ã€‚
- æ¨ªãƒãƒ¡ (yokohame): ç®±ã‚’æ¨ªã«ã—ã¦æ£’ã®é–“ã«é€šã™ã€‚æ£’é–“éš”ãŒåºƒã„æ™‚ã«æœ‰åŠ¹ã€‚5~8å›ã€‚
- å¯„ã› (yose): ç‰‡æ–¹ã®çˆªã§æ™¯å“ã‚’å¼•ãå¯„ã›ã‚‹
- ãšã‚‰ã— (zurashi): å°‘ã—ãšã¤æŠ¼ã—ã¦ç§»å‹•ã•ã›ã‚‹
- ãã‚‹ã‚Šã‚“ã± (kururinpa): ç«¯ã‚’æŠ¼ã—ã¦åå‹•ã§è£è¿”ã™
- ãŸã“ç„¼ã (takoyaki): çƒã‚’ç©´ã«å…¥ã‚Œã‚‹ç¢ºç‡å‹
- æ­¢ã‚æ›ã‘ (tomekake): ç‰‡æ–¹ã®çˆªã§æŠ¼ã•ãˆã€ã‚‚ã†ç‰‡æ–¹ã§æŒã¡ä¸Šã’ã‚‹
- ã¡ã‚ƒã¶å° (chabudai): ã²ã£ãã‚Šè¿”ã—æŠ€è¡“
- ã‚¹ãƒ©ã‚¤ãƒ‰ (slide): é«˜ã„æ£’ã‹ã‚‰æ™¯å“ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã•ã›ã‚‹
- å‰è½ã¨ã— (maeotoshi): å¾Œéƒ¨ã‚’äº¤äº’ã«å¼•ã„ã¦å‰æ–¹ã«è½ã¨ã™

ã€å…±é€šæ”»ç•¥åŸå‰‡ â€” å¿…ãšè€ƒæ…®ã™ã‚‹ã“ã¨ã€‘
1. ã€ŒæŒã¡ä¸Šã’ã‚‹ã€ã‚ˆã‚Šã€ŒæŠ¼ã™ãƒ»è»¢ãŒã™ãƒ»å‚¾ã‘ã‚‹ã€ã‚’å„ªå…ˆ
2. å¸¸ã«é‡å¿ƒã¨æ”¯æŒç‚¹ã®é–¢ä¿‚ã«é›†ä¸­
3. ç‰‡å´ã ã‘ã‚’ç¹°ã‚Šè¿”ã—æ”»ã‚ã¦ç§»å‹•ã‚’è“„ç©ã•ã›ã‚‹
4. ã‚¢ãƒ¼ãƒ åŠ›ãŒå¼±ã„å ´åˆã¯æ´ã‚€ã®ã§ã¯ãªãæŠ¼ã™ãƒ»å¼•ãæˆ¦ç•¥ã‚’å„ªå…ˆ
5. æ™¯å“ãŒå¤§ãã™ãã¦ã‚¢ãƒ¼ãƒ ã§æ´ã‚ãªã„å ´åˆã¯ã€Œãƒã‚¸ã‚·ãƒ§ãƒ³å¤‰æ›´ã‚’å¾…ã¤ã€ã‹ã€Œè«¦ã‚ã‚‹ã€ã‚’æ¨å¥¨

ã€ç‰©ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åˆ†æ â€” å†™çœŸã‹ã‚‰æ¨å®šã€‘
- æ£’é–“éš” vs æ™¯å“ã‚µã‚¤ã‚ºã®æ¯”ç‡
- æ™¯å“ã®å‚¾ãè§’åº¦ï¼ˆæ°´å¹³åŸºæº–ï¼‰
- æ£’ã¨æ™¯å“ã®æ¥è§¦ç‚¹ã®æ•°
- å‡ºå£ã¾ã§ã®æ¨å®šè·é›¢
- é‡å¿ƒä½ç½®ã®æ¨å®šï¼ˆæ ¹æ‹ ã‚’æ˜è¨˜ï¼‰

ã€é‡å¿ƒæ¨å®šã‚¬ã‚¤ãƒ‰ã€‘
- é ­ãŒå¤§ãã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ â†’ é‡å¿ƒãŒä¸Šéƒ¨ï¼ˆã²ã£ãã‚Šè¿”ã—ã‚„ã™ã„ï¼‰
- ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå½¢ â†’ é‡å¿ƒãŒä¸­å¤®ï¼ˆæ¨™æº–æ”»ç•¥ï¼‰
- ä¸‹åŠèº«ãŒé‡ã„å½¢ â†’ é‡å¿ƒãŒä¸‹éƒ¨ï¼ˆæŠ¼ã—ä¸­å¿ƒæ”»ç•¥ï¼‰
- ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ç®± â†’ å†…å®¹ç‰©ã®åã‚Šã§é‡å¿ƒæ¨å®š

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚å¿…ãšæœ‰åŠ¹ãªJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š

{
  "situation_analysis": {
    "machine_type": "ì‚¬ì§„ì—ì„œ í™•ì¸ ê°€ëŠ¥í•œ ê¸°ê³„ ì •ë³´ë§Œ ê¸°ìˆ . ë³´ì´ì§€ ì•Šìœ¼ë©´ 'í™•ì¸ ë¶ˆê°€'",
    "claw_type": "two_arm / three_arm / pincer / unknown ì¤‘ íƒ1",
    "claw_detail": "ì§‘ê²Œì— ëŒ€í•œ ì¶”ê°€ ì„¤ëª… (ë³´ì´ëŠ” ê²½ìš°ë§Œ)",
    "setup_type": "hashiwatashi / suehirogari / maeotoshi / rubber_shovel / ring / corner_balance / probability ì¤‘ íƒ1",
    "setup_detail": "ì„¸íŒ… ìœ í˜•ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…",
    "prize_type": "ìƒí’ˆ ì¢…ë¥˜ ë° ì¶”ì • ë¬´ê²Œ (ê·¼ê±° í¬í•¨)",
    "current_position": "ìƒí’ˆì˜ í˜„ì¬ ìœ„ì¹˜ì™€ ê°ë„ ìƒì„¸ ì„¤ëª… (ë³´ì´ëŠ” ê²ƒë§Œ)",
    "weight_center": "ì¶”ì • ë¬´ê²Œ ì¤‘ì‹¬ ìœ„ì¹˜ (ê·¼ê±° í¬í•¨)",
    "weight_center_type": "head_heavy / balanced / bottom_heavy ì¤‘ íƒ1",
    "bar_gap_ratio": "ë´‰ ê°„ê²© ëŒ€ë¹„ ìƒí’ˆ í¬ê¸° ë¹„ìœ¨ (ì¶”ì •, ì˜ˆ: 'ì•½ 0.8'). ë´‰ì´ ì—†ìœ¼ë©´ null",
    "tilt_angle": "í˜„ì¬ ê¸°ìš¸ê¸° ê°ë„ ì¶”ì • (ì˜ˆ: 'ì•½ 15ë„'). í™•ì¸ ë¶ˆê°€ì‹œ null",
    "difficulty": "1-10 ìˆ«ì",
    "not_visible": ["ì‚¬ì§„ì—ì„œ í™•ì¸í•  ìˆ˜ ì—†ëŠ” ìš”ì†Œ ëª©ë¡"]
  },
  "technique": {
    "primary": "ì¶”ì²œ ë©”ì¸ í…Œí¬ë‹‰ì˜ ì¼ë³¸ì–´ëª… (æ©‹æ¸¡ã—/ç¸¦ãƒãƒ¡/æ¨ªãƒãƒ¡/å¯„ã›/ãšã‚‰ã—/ãã‚‹ã‚Šã‚“ã±/æ­¢ã‚æ›ã‘/ã¡ã‚ƒã¶å°/ã‚¹ãƒ©ã‚¤ãƒ‰/å‰è½ã¨ã— ì¤‘ íƒ1)",
    "primary_kr": "í•œêµ­ì–´ í…Œí¬ë‹‰ëª…",
    "reason": "ì´ í…Œí¬ë‹‰ì„ ì¶”ì²œí•˜ëŠ” ì´ìœ  (ìƒì„¸í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ - ë¬¼ë¦¬ì  ê·¼ê±° í¬í•¨)",
    "alternative": "ëŒ€ì•ˆ í…Œí¬ë‹‰ (ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ null)",
    "alternative_kr": "ëŒ€ì•ˆ í…Œí¬ë‹‰ í•œêµ­ì–´ëª… (ì„ íƒì‚¬í•­)"
  },
  "steps": [
    {
      "step": 1,
      "action": "í•œì¤„ í–‰ë™ ìš”ì•½ (10ê¸€ì ì´ë‚´, ì˜ˆ: 'ì™¼ìª½ ëª¨ì„œë¦¬ ë°€ê¸°')",
      "direction": "left/right/forward/back/center",
      "where": "ğŸ“ ì§‘ê²Œë¥¼ ë‚´ë ¤ë†“ì„ ì •í™•í•œ ìœ„ì¹˜. ì˜ˆ: 'ë°•ìŠ¤ ì™¼ìª½ ëì—ì„œ ì‚´ì§ ì™¼ìª½ (ì•½ 1cm)'",
      "mechanism": "âš¡ ì§‘ê²Œê°€ ë‹«í ë•Œ ì¼ì–´ë‚˜ëŠ” ì¼. ì˜ˆ: 'ì˜¤ë¥¸ìª½ ë°œë§Œ ë°•ìŠ¤ ì™¼ìª½ ëª¨ì„œë¦¬ì— ê±¸ë¦¬ë©´ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ì–´ëƒ„'",
      "expected_result": "ğŸ“¦ ì´ ë™ì‘ í›„ ì˜ˆìƒ ê²°ê³¼. ì˜ˆ: 'ë°•ìŠ¤ê°€ ì‹œê³„ë°©í–¥ìœ¼ë¡œ ì•½ 10~15ë„ íšŒì „'",
      "marker_x_percent": 50,
      "marker_y_percent": 50,
      "marker_label": "ì§§ì€ ë¼ë²¨ (4ê¸€ì ì´ë‚´)"
    }
  ],
  "warnings": ["ì£¼ì˜ì‚¬í•­ 1", "ì£¼ì˜ì‚¬í•­ 2"],
  "pro_tips": ["ê³ ìˆ˜ íŒ 1 (ì¼ë³¸ í˜„ì§€ ë…¸í•˜ìš°)", "ê³ ìˆ˜ íŒ 2"],
  "staff_chance": "ì§ì› ì°¬ìŠ¤ë¥¼ ìš”ì²­í•  íƒ€ì´ë° ì¡°ì–¸ (ì˜ˆ: '3íšŒ ì‹œë„ í›„ ì›€ì§ì„ì´ ì—†ìœ¼ë©´ ìš”ì²­'). ë¶ˆí•„ìš”ì‹œ null",
  "success_rate": "ì˜ˆìƒ ì„±ê³µ í™•ë¥  (%)",
  "estimated_tries": "ì˜ˆìƒ ì†Œìš” íšŸìˆ˜",
  "estimated_cost": "ì˜ˆìƒ ë¹„ìš© (ì˜ˆ: 'ì•½ 500~1000ì—”')",
  "give_up_recommendation": false,
  "give_up_reason": ""
}

ã€ãƒãƒ¼ã‚«ãƒ¼é…ç½®ãƒ«ãƒ¼ãƒ« - éå¸¸ã«é‡è¦ã€‘
- å„ã‚¹ãƒ†ãƒƒãƒ—ã®marker_x_percentã¨marker_y_percentã¯ã€å®Ÿéš›ã«é›†è¨ˆã‚’é™ã‚ã™ã¹ããƒã‚¤ãƒ³ãƒˆã‚’ç¤ºã™
- ãƒãƒ¼ã‚«ãƒ¼åŒå£«ãŒé‡ãªã‚‰ãªã„ã‚ˆã†ã€æœ€ä½15%ä»¥ä¸Šã®é–“éš”ã‚’ç©ºã‘ã‚‹ã“ã¨
- ã‚‚ã—ãƒã‚¤ãƒ³ãƒˆãŒè¿‘ã„å ´åˆã¯ã€marker_x_percentã¾ãŸã¯marker_y_percentã‚’ãšã‚‰ã—ã¦è¦–èªæ€§ã‚’ç¢ºä¿ã™ã‚‹
- marker_labelã¯æœ€å¤§4æ–‡å­—ï¼ˆä¾‹: "1ì°¨ë°€ê¸°", "ë‚™í•˜ì ", "íšŒì „"ï¼‰

ã€ã‚¹ãƒ†ãƒƒãƒ—ã®detailè¨˜è¼‰ãƒ«ãƒ¼ãƒ« â€” è¶…é‡è¦ï¼šåˆå¿ƒè€…ã¯ã€ŒæŠ¼ã™ã€ã®æ„å‘³ã™ã‚‰åˆ†ã‹ã‚‰ãªã„ã€‘

â˜… UFOã‚­ãƒ£ãƒƒãƒãƒ£ãƒ¼ã§ã€ŒæŠ¼ã™ã€ã€Œãšã‚‰ã™ã€ã¨ã¯ä½•ã‹ â€” å¿…ãšå…·ä½“çš„ã«èª¬æ˜ã™ã‚‹ã“ã¨ï¼š
- ã‚¯ãƒ¬ãƒ¼ãƒ³ã‚²ãƒ¼ãƒ ã®ã‚¢ãƒ¼ãƒ ã¯ã€Œä¸‹é™â†’é–‰ã˜ã‚‹â†’ä¸Šæ˜‡ã€ã—ã‹ã§ããªã„
- ã€ŒæŠ¼ã™ã€ã¨ã¯ï¼šã‚¢ãƒ¼ãƒ ã‚’æ™¯å“ã®ç«¯ã‚®ãƒªã‚®ãƒªã«é™ã‚ã—ã€ã‚¢ãƒ¼ãƒ ãŒé–‰ã˜ã‚‹æ™‚ã«ç‰‡æ–¹ã®ã‚¢ãƒ¼ãƒ ï¼ˆçˆªï¼‰ã ã‘ãŒæ™¯å“ã®è§’ã‚„ç«¯ã«å½“ãŸã‚Šã€ãã®åŠ›ã§æ™¯å“ãŒæŠ¼ã•ã‚Œã‚‹å‹•ã
- ã€Œå¼•ãã€ã¨ã¯ï¼šã‚¢ãƒ¼ãƒ ã®ç‰‡æ–¹ã ã‘ãŒæ™¯å“ã®ç¸ã«å¼•ã£ã‹ã‹ã‚Šã€ä¸Šæ˜‡æ™‚ã«æ™¯å“ã‚’å¼•ããšã‚‹å‹•ã
- åˆå¿ƒè€…ã¯ã‚¢ãƒ¼ãƒ ã®å¹…ã¨æ™¯å“ã®ã‚µã‚¤ã‚ºã®é–¢ä¿‚ã‚’ç†è§£ã—ã¦ã„ãªã„

â˜… å„ã‚¹ãƒ†ãƒƒãƒ—ã¯3ã¤ã®åˆ¥ã€…ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ï¼ˆé‡è¦ï¼detailã¯ä½¿ã‚ãªã„ï¼‰ï¼š
  - "where": é›†è¨ˆã‚’é™ã‚ã™æ­£ç¢ºãªä½ç½®ï¼ˆ1æ–‡ã§ï¼‰
  - "mechanism": é›†è¨ˆãŒé–‰ã˜ã‚‹æ™‚ã«ä½•ãŒèµ·ãã‚‹ã‹ï¼ˆ1æ–‡ã§ï¼‰
  - "expected_result": ã“ã®å‹•ãã§æ™¯å“ãŒã©ã†å¤‰ã‚ã‚‹ã‹ï¼ˆ1æ–‡ã§ï¼‰

â˜… å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¨˜è¿°ãƒ«ãƒ¼ãƒ«ï¼š
  - "where" ã«ã¯ã€Œã‚¢ãƒ¼ãƒ ã®ä¸­å¿ƒã‚’ã©ã“ã«åˆã‚ã›ã‚‹ã‹ã€ã‚’æ›¸ãã€‚æ™¯å“ã®ã©ã®éƒ¨åˆ†ã®çœŸä¸Šã‹ã€‚
  - "mechanism" ã«ã¯ã€Œã©ã¡ã‚‰ã®çˆªãŒæ™¯å“ã«å½“ãŸã‚‹ã‹ã€ã€Œé–‰ã˜ã‚‹åŠ›ã§ã©ã†æŠ¼ã•ã‚Œã‚‹ã‹ã€ã‚’æ›¸ãã€‚
  - "expected_result" ã«ã¯ã€Œäºˆæƒ³ã•ã‚Œã‚‹å¤‰åŒ–ã€ã‚’å…·ä½“çš„ã«æ›¸ãï¼ˆã€‡åº¦å›è»¢ã€ã€‡cmç§»å‹•ãªã©ï¼‰ã€‚

â˜… è¨˜è¿°ä¾‹ï¼š
BAD (1ã¤ã®detailã«å…¨éƒ¨æ›¸ã): "ë°•ìŠ¤ì˜ ì™¼ìª½ ëª¨ì„œë¦¬ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ê¸°. ë¬´ê²Œì¤‘ì‹¬ì´..."
GOOD (3ã¤ã«åˆ†ã‘ã‚‹):
  "where": "ë°•ìŠ¤ ì™¼ìª½ ëì—ì„œ ì•½ 1cm ì™¼ìª½ì— ì§‘ê²Œ ì¤‘ì‹¬ì„ ë§ì¶”ì„¸ìš”"
  "mechanism": "ì§‘ê²Œê°€ ë‹«í ë•Œ ì˜¤ë¥¸ìª½ ë°œë§Œ ë°•ìŠ¤ ì™¼ìª½ ëª¨ì„œë¦¬ì— ê±¸ë ¤ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ì–´ëƒ…ë‹ˆë‹¤"
  "expected_result": "ë°•ìŠ¤ê°€ ì‹œê³„ë°©í–¥ìœ¼ë¡œ ì•½ 10~15ë„ íšŒì „í•©ë‹ˆë‹¤"

â˜… ã‚¢ãƒ¼ãƒ ã®å¹…ãŒæ™¯å“ã‚ˆã‚Šå¤§ãã„/å°ã•ã„/åŒã˜ãã‚‰ã„ã®å ´åˆã€ãã‚Œãã‚Œæˆ¦ç•¥ãŒå¤‰ã‚ã‚‹ã“ã¨ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨

å¿…ãšæœ‰åŠ¹ãªJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
`;

export async function POST(request) {
  try {
    const { imageBase64, imageMediaType, machineType, prizeType } = await request.json();

    if (!imageBase64) {
      return NextResponse.json({ error: 'ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, { status: 400 });
    }

    const apiKey = process.env.ANTHROPIC_API_KEY;
    if (!apiKey) {
      return NextResponse.json({ error: 'API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' }, { status: 500 });
    }

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 4096,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: {
                type: 'base64',
                media_type: imageMediaType || 'image/jpeg',
                data: imageBase64,
              },
            },
            {
              type: 'text',
              text: ANALYSIS_PROMPT(machineType, prizeType),
            },
          ],
        }],
      }),
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      console.error('Anthropic API error:', errData);
      return NextResponse.json(
        { error: errData?.error?.message || `AI API ì˜¤ë¥˜ (${response.status})` },
        { status: response.status }
      );
    }

    const data = await response.json();
    const text = data.content?.map(i => i.text || '').filter(Boolean).join('\n') || '';

    if (!text) {
      return NextResponse.json({ error: 'AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.' }, { status: 500 });
    }

    let parsed;
    try {
      const clean = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
      parsed = JSON.parse(clean);
    } catch {
      try {
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          parsed = JSON.parse(jsonMatch[0]);
        } else {
          throw new Error('JSON not found');
        }
      } catch {
        console.error('JSON parse failed:', text);
        return NextResponse.json({ error: 'AI ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, { status: 500 });
      }
    }

    if (!parsed.steps || !Array.isArray(parsed.steps)) {
      return NextResponse.json({ error: 'ë¶„ì„ ê²°ê³¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' }, { status: 500 });
    }

    return NextResponse.json({ analysis: parsed });

  } catch (err) {
    console.error('Analyze API error:', err);
    return NextResponse.json({ error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, { status: 500 });
  }
}
